<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ROSES • Profil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{
      min-height:100vh;
      background:
        radial-gradient(900px 450px at 10% 10%, rgba(37,99,235,.20), transparent 60%),
        radial-gradient(700px 420px at 90% 10%, rgba(220,38,38,.18), transparent 60%),
        radial-gradient(700px 520px at 50% 100%, rgba(22,163,74,.14), transparent 65%),
        #0b1220;
      color:#eaf0ff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .cardx{
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .topbar{
      padding:18px 22px;
      background: linear-gradient(135deg, rgba(220,38,38,.28), rgba(37,99,235,.22));
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .pill{ border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); }
    .avatar{ width:64px; height:64px; border-radius:18px; object-fit:cover; border:1px solid rgba(255,255,255,.20); }
    .muted{ color: rgba(234,240,255,.75); }
    code{ color:#fff; }
  </style>
</head>
<body>
  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-xl-7">

        <div class="cardx">
          <div class="topbar d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <div class="fw-bold">ROSES • Profil</div>
              <div class="muted small">Papar token login & simpan profil di pelayar</div>
            </div>
            <span class="badge rounded-pill pill px-3 py-2">Merah • Putih • Biru • Hijau</span>
          </div>

          <div class="p-4">
            <div id="alert" class="alert alert-warning d-none" role="alert"></div>

            <div class="d-flex align-items-center gap-3 mb-3">
              <img id="pic" class="avatar" alt="Foto profil" src=""/>
              <div>
                <div class="h5 mb-0" id="name">-</div>
                <div class="muted" id="email">-</div>
                <div class="muted small">Login terakhir: <b id="lastLogin">-</b></div>
              </div>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <div class="p-3 rounded-4 border border-light border-opacity-10">
                  <div class="muted small mb-1">ID Token (dipendekkan)</div>
                  <code id="tokenShort">-</code>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 rounded-4 border border-light border-opacity-10">
                  <div class="muted small mb-1">Domain / Issuer</div>
                  <code id="issuer">-</code>
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button class="btn btn-light" id="btnSave">Simpan Profil</button>
              <button class="btn btn-outline-light" id="btnClear">Padam Profil</button>
              <button class="btn btn-primary ms-auto" id="btnOpenApp">Buka Web App ROSES</button>
            </div>

            <div class="mt-3 muted small">
              Nota: Halaman ini hanya <b>membaca</b> token pada URL (fragment/query), memaparkan maklumat,
              dan menyimpan ke <i>localStorage</i>. Tiada data dihantar ke pelayan dari halaman ini.
            </div>
          </div>
        </div>

        <div class="text-center mt-4 muted small">
          <a class="link-light" href="./index.html">← Kembali</a>
        </div>

      </div>
    </div>
  </main>

<script>
  const KEY_PROFILE = "roses_profile";
  const KEY_GATEWAY = "roses_gateway";
  const APP_URL = "https://script.google.com/macros/s/AKfycbw2SESSgVwauvEzzOXA144jg3LIE9DHQ5kVYYcFfNwP09SWFS-0z9C7wthI8tF7Xwlo7g/exec";

  function showAlert(msg){
    const a = document.getElementById("alert");
    a.textContent = msg;
    a.classList.remove("d-none");
  }

  function getParam(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name) || "";
  }

  function getToken(){
    const hash = (window.location.hash || "").replace(/^#/, "");
    const sp = new URLSearchParams(hash);
    const t1 = sp.get("id_token") || "";
    if (t1) return t1;
    const t2 = getParam("id_token");
    if (t2) return t2;
    return "";
  }

  function b64urlDecode(str){
    try {
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4;
      if (pad) str += "=".repeat(4 - pad);
      const raw = atob(str);
      const bytes = Uint8Array.from(raw, c => c.charCodeAt(0));
      return new TextDecoder().decode(bytes);
    } catch(e) {
      return "";
    }
  }

  function decodeJwtPayload(token){
    const parts = String(token||"").split(".");
    if (parts.length < 2) return null;
    const payload = b64urlDecode(parts[1]);
    if (!payload) return null;
    try { return JSON.parse(payload); } catch(e) { return null; }
  }

  function fmt(ts){
    try {
      const d = new Date(ts);
      return d.toLocaleString("ms-MY", { hour12:false });
    } catch(e){ return "-"; }
  }

  function loadGatewayInfo(){
    const gw = JSON.parse(localStorage.getItem(KEY_GATEWAY) || "{}");
    document.getElementById("lastLogin").textContent = gw.lastLogin ? fmt(gw.lastLogin) : "-";
  }

  function renderFromProfile(p, token){
    document.getElementById("name").textContent = p?.name || p?.given_name || "-";
    document.getElementById("email").textContent = p?.email || "-";
    document.getElementById("issuer").textContent = p?.iss || p?.hd || "-";
    document.getElementById("pic").src = p?.picture || "";
    document.getElementById("tokenShort").textContent = token ? (token.slice(0,18) + "..." + token.slice(-10)) : "-";
  }

  const token = getToken();
  const payload = token ? decodeJwtPayload(token) : null;

  if (!token) {
    showAlert("Tiada id_token dijumpai pada URL. Jika anda baru login, pastikan URL mengandungi #id_token=... atau ?id_token=...");
  }

  if (payload) {
    renderFromProfile(payload, token);
  } else {
    const saved = JSON.parse(localStorage.getItem(KEY_PROFILE) || "null");
    if (saved) renderFromProfile(saved.profile, saved.token || "");
  }

  document.getElementById("btnSave").addEventListener("click", ()=>{
    if (!payload) return showAlert("Tiada payload token untuk disimpan.");
    localStorage.setItem(KEY_PROFILE, JSON.stringify({
      savedAt: Date.now(),
      profile: payload,
      token: token
    }));
    showAlert("Profil disimpan di pelayar (localStorage).");
  });

  document.getElementById("btnClear").addEventListener("click", ()=>{
    localStorage.removeItem(KEY_PROFILE);
    showAlert("Profil dipadam.");
  });

  document.getElementById("btnOpenApp").addEventListener("click", ()=>{
    if (token) {
      window.location.href = APP_URL + "#id_token=" + encodeURIComponent(token);
    } else {
      window.location.href = APP_URL;
    }
  });

  loadGatewayInfo();
</script>
</body>
</html>
