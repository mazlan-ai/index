<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROSES ‚Ä¢ Login</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --red:#dc2626; --blue:#2563eb; --green:#16a34a;
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#ffffff, var(--bg)); color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 30px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{width:40px;height:40px;border-radius:12px; background:
      conic-gradient(from 180deg, var(--red), var(--blue), var(--green), var(--red));
      box-shadow:0 8px 18px rgba(2,6,23,.12);
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:15px;letter-spacing:.2px}
    .title span{display:block;font-size:12px;color:var(--muted)}
    .chip{font-size:12px;color:var(--muted);padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;}
    .grid{display:grid;gap:14px;margin-top:14px;grid-template-columns: 1.15fr .85fr;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr;} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden;}
    .hero{padding:18px;}
    .hero h1{margin:0 0 8px;font-size:22px;}
    .hero p{margin:0;color:var(--muted);font-size:14px;line-height:1.5}
    .actions{padding:18px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .btn{border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px 12px; font-weight:600; cursor:pointer;}
    .btn.primary{border:none;background:linear-gradient(90deg,var(--red),var(--blue)); color:#fff;}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .checkbox{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);}
    .hint{padding:14px 18px;color:var(--muted);font-size:13px;border-top:1px dashed var(--border);}
    .profile{padding:18px;}
    .phead{display:flex;gap:12px;align-items:center;}
    .avatar{width:54px;height:54px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);display:grid;place-items:center;overflow:hidden;font-weight:700;color:#334155}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .pmeta b{display:block;font-size:14px}
    .pmeta span{display:block;font-size:12px;color:var(--muted)}
    .kv{margin-top:12px;display:grid;grid-template-columns: 120px 1fr;gap:8px;font-size:13px}
    .kv .k{color:var(--muted)}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
    .gbtn{min-height:42px}
  </style>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>ROSES</b>
          <span>Login Gateway</span>
        </div>
      </div>
      <div class="chip" id="lastLoginChip">Belum login</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hero">
          <h1>Selamat datang üëã</h1>
          <p>Sila log masuk menggunakan akaun Google. Selepas berjaya, anda akan terus masuk ke Dashboard ROSES.</p>
        </div>

        <div class="actions">
          <div class="row">
            <div id="gSignInBtn" class="gbtn"></div>
            <button class="btn primary" id="btnGo" disabled onclick="goDashboard()">Terus ke Dashboard</button>
          </div>

          <label class="checkbox">
            <input type="checkbox" id="rememberMe" checked />
            Remember me
          </label>
        </div>

        <div class="hint">
          Tip: Jika guru guna telefon, login sekali dan pilih ‚ÄúRemember me‚Äù untuk masuk terus lain kali.
        </div>
      </div>

      <div class="card">
        <div class="profile">
          <div class="phead">
            <div class="avatar" id="avatarBox">?</div>
            <div class="pmeta">
              <b id="nameVal">-</b>
              <span id="emailVal">-</span>
            </div>
          </div>

          <div class="kv">
            <div class="k">User ID</div><div class="v" id="subVal">-</div>
            <div class="k">Status</div><div class="v" id="statusVal">LOGOUT</div>
          </div>
        </div>

        <div class="actions" style="justify-content:space-between">
          <button class="btn" onclick="clearSession()">Reset</button>
          <button class="btn" onclick="goDashboard(true)">Masuk semula</button>
        </div>
      </div>
    </div>

    <div class="footer">¬© ROSES ‚Ä¢ Mesra pengguna & smartphone</div>
  </div>

<script>
  const KEY_LS = "ROSES_SESSION";
  const KEY_SS = "ROSES_SESSION_SS";

  function saveSession(session, remember){
    const raw = JSON.stringify(session);
    if(remember){
      localStorage.setItem(KEY_LS, raw);
      sessionStorage.removeItem(KEY_SS);
    } else {
      sessionStorage.setItem(KEY_SS, raw);
      localStorage.removeItem(KEY_LS);
    }
  }
  function loadSession(){
    const a = localStorage.getItem(KEY_LS);
    const b = sessionStorage.getItem(KEY_SS);
    try{ return JSON.parse(a || b || "null"); }catch(e){ return null; }
  }
  function clearSession(){
    localStorage.removeItem(KEY_LS);
    sessionStorage.removeItem(KEY_SS);
    render();
  }
  function setLastLogin(ts){
    try{
      const d = new Date(ts);
      const s = d.toLocaleString("ms-MY");
      document.getElementById("lastLoginChip").textContent = "Last login: " + s;
    }catch(e){
      document.getElementById("lastLoginChip").textContent = "Belum login";
    }
  }
  function decodeJwt(token){
    try{
      const p = token.split(".")[1];
      const json = atob(p.replace(/-/g,'+').replace(/_/g,'/'));
      return JSON.parse(decodeURIComponent(escape(json)));
    }catch(e){ return null; }
  }

  function render(){
    const s = loadSession();
    const avatar = document.getElementById("avatarBox");
    const nameEl = document.getElementById("nameVal");
    const emailEl = document.getElementById("emailVal");
    const subEl = document.getElementById("subVal");
    const statusEl = document.getElementById("statusVal");
    const btnGo = document.getElementById("btnGo");

    if(!s){
      avatar.textContent = "?";
      nameEl.textContent = "-";
      emailEl.textContent = "-";
      subEl.textContent = "-";
      statusEl.textContent = "LOGOUT";
      btnGo.disabled = true;
      document.getElementById("lastLoginChip").textContent = "Belum login";
      return;
    }
    const p = s.profile || {};
    const initial = (String(p.name||p.email||"?").trim().slice(0,1) || "?").toUpperCase();
    if(p.picture){
      avatar.innerHTML = '<img alt="Profil" src="'+p.picture+'" referrerpolicy="no-referrer" onerror="this.remove(); document.getElementById(\\'avatarBox\\').textContent=\\''+initial+'\\';" />';
      avatar.textContent = initial;
    } else {
      avatar.textContent = initial;
    }
    nameEl.textContent = p.name || "(Tiada nama)";
    emailEl.textContent = p.email || "(Tiada email)";
    subEl.textContent = p.sub || "-";
    statusEl.textContent = "AKTIF";
    btnGo.disabled = false;
    setLastLogin(s.lastLogin || Date.now());
  }

  function goDashboard(force){
    const s = loadSession();
    if(!s) return alert("Sila login dahulu.");
    if(force){
      s.lastLogin = Date.now();
      saveSession(s, !!s.remember);
    }
    window.location.href = "./dashboard.html";
  }

  function initGoogle(){
    if(!window.google || !google.accounts || !google.accounts.id) return setTimeout(initGoogle, 200);

    google.accounts.id.initialize({
      client_id: "1080063104374-2ne8o0a4f6s7ve55nt4ntq0sfc2b772g.apps.googleusercontent.com",
      callback: onCredential,
      auto_select: false,
      cancel_on_tap_outside: false
    });

    google.accounts.id.renderButton(document.getElementById("gSignInBtn"), {
      theme: "outline",
      size: "large",
      width: 260
    });
  }

  function onCredential(resp){
    const token = resp && resp.credential;
    const payload = decodeJwt(token);
    if(!payload) return alert("Token login tidak sah. Cuba lagi.");

    const remember = document.getElementById("rememberMe").checked;
    const session = {
      id_token: token,
      profile: {
        sub: payload.sub || "",
        name: payload.name || payload.given_name || "",
        email: payload.email || "",
        picture: payload.picture || ""
      },
      remember,
      lastLogin: Date.now()
    };
    saveSession(session, remember);
    render();
  }

  window.addEventListener("DOMContentLoaded", () => {
    render();
    initGoogle();
  });
</script>
</body>
</html>
